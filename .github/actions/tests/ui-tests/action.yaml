name: 'Upload Failed Job Logs'
description: 'On workflow job failure, fetch and send relevant logs with branch information to an external API'
author: 'konrad'
inputs:
  ui_markers:
    description: 'Markers to filter tests'
    required: true
  aws_acces_key_id: 
    description: 'AWS access key ID'
    required: true
  aws_secret_access_key:
    description: 'AWS secret access key'
    required: true
  matrix:
    description: 'Matrix for the test'
    required: false  
runs:
  using: "composite"
  steps:
    - name: Install Node.js 18.16
      uses: actions/setup-node@v4
      with:
        node-version: "18.16"
        cache-dependency-path: tyk-analytics/tests/ui
        cache: 'npm'
    - name: Execute UI tests
      working-directory: tyk-analytics/tests/ui
      id: test_execution
      shell: bash
      env:
        GW_URL: 'https://localhost:8080/'
        NODE_TLS_REJECT_UNAUTHORIZED: 0
        UI_MARKERS: ${{ inputs.ui_markers && format('--grep {0}', inputs.ui_markers ) || '' }}
      run: |
        npm ci
        npx playwright install --with-deps chromium
        PLAYWRIGHT_JUNIT_OUTPUT_NAME=${XUNIT_REPORT_PATH} npx playwright test --project=chromium --reporter=junit,html $UI_MARKERS
    - name: Upload Playwright Test Report to S3
      shell: bash
      if: failure() && steps.test_execution.outcome != 'success' && steps.env_up.outcome == 'success'
      run:
        npm run upload_report_to_s3
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_acces_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        RUN_ID: 'tyk-analytics/${{ github.run_id }}'
      working-directory: tyk-analytics/tests/ui

    - name: Share S3 report link into summary
      if: failure() && steps.test_execution.outcome != 'success' && steps.env_up.outcome == 'success'
      shell: bash
      run: |
        echo "# :clipboard: S3 UI Test REPORT: {{`${{ inputs.matrix.envfiles.db }}`}}-{{`${{ inputs.matrix.envfiles.conf }}`}}" >> $GITHUB_STEP_SUMMARY
        echo "- Status: {{`${{ steps.test_execution.outcome == 'success' && ':white_check_mark:' || ':no_entry_sign:' }}`}}" >> $GITHUB_STEP_SUMMARY
        echo "- [Link to report](https://tyk-qa-reports.s3.eu-central-1.amazonaws.com/tyk-analytics/{{`${{ github.run_id }}`}}/index.html)" >> $GITHUB_STEP_SUMMARY
