name: Cherry-pick to Release Branch

on:
  issue_comment:
    types: [created]
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry_pick:
    runs-on: ubuntu-latest
    steps:
      - name: Check for release command
        id: check_command
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, comment } = context.payload;
            if (!issue || !issue.pull_request || !comment || !comment.body?.startsWith('/release to ')) {
              core.setOutput('release_valid', 'false');
              return;
            }
            const releaseBranch = comment.body.split('/release to ')[1].trim();
            core.setOutput('release_valid', 'true');
            core.setOutput('release_branch', releaseBranch);
            core.setOutput('pr_number', issue.number);

      - name: Checkout repository
        if: steps.check_command.outputs.release_valid == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git user
        if: steps.check_command.outputs.release_valid == 'true'
        run: |
          git config --global user.email "bot@tyk.io"
          git config --global user.name "Tyk Bot"

      - name: Read PR details
        id: pr_details
        if: steps.check_command.outputs.release_valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          data=$(gh pr view ${{ steps.check_command.outputs.pr_number }} --json headRefOid,title)
          echo "COMMIT_SHA=$(jq -r '.headRefOid' <<<"$data")" >> "$GITHUB_OUTPUT"
          echo "PR_TITLE=$(jq -r '.title' <<<"$data")" >> "$GITHUB_OUTPUT"

      - name: Cherry-pick PR head commit onto target release
        id: cherry_pick
        if: steps.check_command.outputs.release_valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_BRANCH: ${{ steps.check_command.outputs.release_branch }}
          PR_NUMBER: ${{ steps.check_command.outputs.pr_number }}
          COMMIT_SHA: ${{ steps.pr_details.outputs.COMMIT_SHA }}
          PR_TITLE: ${{ steps.pr_details.outputs.PR_TITLE }}
        run: |
          set -eo pipefail

          # Ensure the PR head commit object exists locally (works for forks).
          git fetch origin "pull/${PR_NUMBER}/head:refs/remotes/origin/pr-${PR_NUMBER}"

          # Update and switch to the target release branch.
          git checkout "${TARGET_BRANCH}"
          git pull --ff-only

          # Build a clean branch name.
          JIRA_ID=$(echo "${PR_TITLE}" | grep -oE '[A-Z]{1,10}-[0-9]{1,10}' | head -n 1 || true)
          BRANCH_NAME="merge/${TARGET_BRANCH}/${COMMIT_SHA}"
          if [ -n "${JIRA_ID}" ]; then
            BRANCH_NAME="${BRANCH_NAME}/${JIRA_ID}"
          fi

          # Remove any stale branch locally/remotely.
          git branch -D "${BRANCH_NAME}" 2>/dev/null || true
          git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true

          # Create the integration branch.
          git switch -c "${BRANCH_NAME}"

          # Cherry-pick the PR head commit.
          MERGE_FAILED=0
          git cherry-pick -x "${COMMIT_SHA}" || MERGE_FAILED=$?

          # If it conflicted, try auto-resolving and continue as draft.
          if [ "${MERGE_FAILED}" -ne 0 ]; then
            git add -A || true
            git -c core.editor=true cherry-pick --continue --no-edit || true
          fi

          git push origin "${BRANCH_NAME}" --force

          # Prepare PR title/body from the original commit.
          TITLE=$(git show -s --format=%s "${COMMIT_SHA}")
          BODY=$(git show -s --format=%B "${COMMIT_SHA}")

          # Create the PR (draft if conflicts occurred).
          PR_URL=$(gh pr create \
            --repo "${REPO}" \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH_NAME}" \
            ${MERGE_FAILED:+--draft} \
            --title "Merging to ${TARGET_BRANCH}: ${TITLE}" \
            --body "${BODY}")

          # Export step outputs for the comment step.
          echo "PR_URL=${PR_URL}" >> "$GITHUB_OUTPUT"
          echo "MERGE_FAILED=${MERGE_FAILED}" >> "$GITHUB_OUTPUT"

      - name: Comment back on original PR
        if: always() && steps.check_command.outputs.release_valid == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prUrl = '${{ steps.cherry_pick.outputs.PR_URL }}';
            const mergeFailed = '${{ steps.cherry_pick.outputs.MERGE_FAILED }}' === '1';
            let body;
            if ('${{ job.status }}' === 'success') {
              body = mergeFailed
                ? `⚠️ Cherry-pick completed with conflicts. A draft PR was created: ${prUrl}`
                : `✅ Cherry-pick successful. A PR was created: ${prUrl}`;
            } else {
              body = '❌ Cherry-pick failed. Please check the workflow logs.';
            }
            github.rest.issues.createComment({
              issue_number: ${{ steps.check_command.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
