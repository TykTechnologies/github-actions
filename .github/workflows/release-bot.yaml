name: Cherry-pick to Release Branch

on:
  issue_comment:
    types: [created]
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry_pick:
    runs-on: ubuntu-latest
    steps:
      - name: Check for release command
        id: check_command
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, comment } = context.payload;
            if (!issue || !issue.pull_request || !comment || !comment.body?.startsWith('/release to ')) {
              core.setOutput('release_valid', 'false');
              return;
            }
            const releaseBranch = comment.body.split('/release to ')[1].trim();
            core.setOutput('release_valid', 'true');
            core.setOutput('release_branch', releaseBranch);
            core.setOutput('pr_number', issue.number);

      - name: Checkout repository
        if: steps.check_command.outputs.release_valid == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git user
        if: steps.check_command.outputs.release_valid == 'true'
        run: |
          git config --global user.email "bot@tyk.io"
          git config --global user.name "Tyk Bot"

      - name: Get PR base and merge SHAs
        id: pr_details
        if: steps.check_command.outputs.release_valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          PR_NUMBER=${{ steps.check_command.outputs.pr_number }}
          OWNER_REPO=${{ github.repository }}
          DEFAULT_BRANCH=${{ env.DEFAULT_BRANCH }}

          # Ask GitHub for the merge commit SHA (works for "Merge" & "Squash" merges).
          PR_JSON=$(gh api repos/${OWNER_REPO}/pulls/${PR_NUMBER})
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          MERGE_SHA=$(echo "$PR_JSON" | jq -r '.merge_commit_sha // empty')

          # Fallback 1: For classic merge commits with default message
          if [ -z "$MERGE_SHA" ] || [ "$MERGE_SHA" = "null" ]; then
            git fetch origin "${DEFAULT_BRANCH}" --quiet
            MERGE_SHA=$(git log origin/${DEFAULT_BRANCH} --merges \
              --grep="Merge pull request #${PR_NUMBER}" \
              -n 1 --pretty=format:%H || true)
          fi

          # Fallback 2: For squash merges (default squash message ends with "(#<PR>)")
          if [ -z "$MERGE_SHA" ]; then
            MERGE_SHA=$(git log origin/${DEFAULT_BRANCH} \
              --grep="(#${PR_NUMBER})" \
              -n 1 --pretty=format:%H || true)
          fi

          if [ -z "$MERGE_SHA" ]; then
            echo "Could not determine merge commit for PR #${PR_NUMBER}" >&2
            exit 1
          fi

          echo "COMMIT_SHA=${MERGE_SHA}" >> "$GITHUB_OUTPUT"
          echo "PR_TITLE=${PR_TITLE}"   >> "$GITHUB_OUTPUT"

      - name: Cherry-pick PR head commit onto target release
        id: cherry_pick
        if: steps.check_command.outputs.release_valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_BRANCH: ${{ steps.check_command.outputs.release_branch }}
          PR_NUMBER: ${{ steps.check_command.outputs.pr_number }}
          COMMIT_SHA: ${{ steps.pr_details.outputs.COMMIT_SHA }}
          PR_TITLE: ${{ steps.pr_details.outputs.PR_TITLE }}
        run: |
          set -eo pipefail

          JIRA_ID=$(echo "$PR_TITLE" | grep -oE '[A-Z]{1,10}-[0-9]{1,10}' | head -n 1 || true)

          # Clone the repository (kept for your act/local testing flow)
          export FOLDER=$(echo $GITHUB_REPO | cut -d '/' -f2)
          rm -rf "$FOLDER"
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPO}"
          cd "$FOLDER"

          # Ensure target exists & is up to date
          git checkout "$GITHUB_BRANCH"
          git pull --ff-only

          # Build branch name
          if [ -n "$JIRA_ID" ]; then
            BRANCH_NAME="merge/$GITHUB_BRANCH/$GITHUB_CHERRY_PICK_COMMIT/$JIRA_ID"
          else
            BRANCH_NAME="merge/$GITHUB_BRANCH/$GITHUB_CHERRY_PICK_COMMIT"
          fi

          # Clean any stale branches
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          git branch -D "merge/$GITHUB_BRANCH/$GITHUB_CHERRY_PICK_COMMIT" 2>/dev/null || true
          git push origin --delete "merge/$GITHUB_BRANCH/$GITHUB_CHERRY_PICK_COMMIT" 2>/dev/null || true

          # Create working branch
          git checkout -b "$BRANCH_NAME"

          # Determine if the selected commit is a merge commit (has >1 parent)
          PARENT_FIELDS=$(git rev-list --parents -n 1 "$GITHUB_CHERRY_PICK_COMMIT" | wc -w)
          # rev-list prints: <sha> <parent1> [parent2 ...]
          # non-merge -> 2 fields; merge -> >=3 fields
          if [ "$PARENT_FIELDS" -gt 2 ]; then
            CHERRYPICK_OPTS="-m 1"
          else
            CHERRYPICK_OPTS=""
          fi

          MERGE_FAILED=0
          git cherry-pick -x ${CHERRYPICK_OPTS} "$GITHUB_CHERRY_PICK_COMMIT" || MERGE_FAILED=$?

          # Try to auto-continue if there were conflicts
          if [ "$MERGE_FAILED" -ne 0 ]; then
            git add -A || true
            git -c core.editor=true cherry-pick --continue --no-edit || true
          fi

          echo "Push the new branch"
          git push origin "$BRANCH_NAME" --force || true

          echo "Prepare the message and title for the PR"
          MESSAGE=$(git show -s --format=%B "$GITHUB_CHERRY_PICK_COMMIT")
          TITLE=$(echo "$MESSAGE" | head -n 1)

          # Create the PR (draft if conflicts observed)
          if [ "$MERGE_FAILED" -ne 0 ]; then
            PR_URL=$(gh pr create --draft \
              --title "Merging to $GITHUB_BRANCH: $TITLE" \
              --body "$MESSAGE" \
              --repo "$GITHUB_REPO" \
              --base "$GITHUB_BRANCH" \
              --head "$BRANCH_NAME")
          else
            PR_URL=$(gh pr create \
              --title "Merging to $GITHUB_BRANCH: $TITLE" \
              --body "$MESSAGE" \
              --repo "$GITHUB_REPO" \
              --base "$GITHUB_BRANCH" \
              --head "$BRANCH_NAME")
          fi

          # Export outputs for the comment step
          echo "PR_URL=${PR_URL}"       >> "$GITHUB_OUTPUT"
          echo "MERGE_FAILED=${MERGE_FAILED}" >> "$GITHUB_OUTPUT"

      - name: Comment back on original PR
        if: always() && steps.check_command.outputs.release_valid == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prUrl = '${{ steps.cherry_pick.outputs.PR_URL }}';
            const mergeFailed = '${{ steps.cherry_pick.outputs.MERGE_FAILED }}' === '1';
            let body;
            if ('${{ job.status }}' === 'success') {
              body = mergeFailed
                ? `⚠️ Cherry-pick completed with conflicts. A draft PR was created: ${prUrl}`
                : `✅ Cherry-pick successful. A PR was created: ${prUrl}`;
            } else {
              body = '❌ Cherry-pick failed. Please check the workflow logs.';
            }
            github.rest.issues.createComment({
              issue_number: ${{ steps.check_command.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
